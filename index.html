<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>D2D Visit Form</title>
<style>
  body { font-family: system-ui, Arial; padding: 20px; max-width: 720px; margin: auto; }
  label { display:block; margin-top:12px; font-weight:600; }
  input[type="text"], input[type="tel"], textarea, input[type="date"], input[type="time"], select {
    width:100%; padding:8px; margin-top:6px; box-sizing:border-box;
  }
  .row { display:flex; gap:10px; }
  .col { flex:1; }
  button { margin-top:16px; padding:10px 14px; font-size:16px; cursor:pointer; }
  .status { margin-top:12px; }
</style>
</head>
<body>
  <h2>D2D Visit Form</h2>
  <form id="d2dForm">
    <label>Full name
      <input type="text" name="fullName" id="fullName" required />
    </label>

    <label>Address
      <textarea name="address" id="address" rows="2" required></textarea>
    </label>

    <div class="row">
      <div class="col">
        <label>Mobile no
          <input type="tel" name="mobile" id="mobile" pattern="[\d+\-\s]+" inputmode="tel" required />
        </label>
      </div>
      <div class="col">
        <label>Visited by
          <input type="text" name="visitedBy" id="visitedBy" required />
        </label>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Date
          <input type="date" name="date" id="date" required />
        </label>
      </div>
      <div class="col">
        <label>Time
          <input type="time" name="time" id="time" required />
        </label>
      </div>
    </div>

    <label>Remarks
      <textarea name="remarks" id="remarks" rows="2"></textarea>
    </label>

    <label>Interested?
      <select name="interested" id="interested">
        <option value="No">No</option>
        <option value="Yes">Yes</option>
      </select>
    </label>

    <label>GPS (captured automatically)
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="text" id="gpsLat" name="gpsLat" placeholder="Latitude" readonly />
        <input type="text" id="gpsLng" name="gpsLng" placeholder="Longitude" readonly />
        <button type="button" id="getGpsBtn">Get GPS</button>
      </div>
    </label>

    <div style="display:flex; gap:10px;">
      <button type="submit">Submit</button>
      <button type="button" id="downloadCsv">Download CSV</button>
    </div>

    <div class="status" id="status"></div>
  </form>

<script>
const WEB_APP_URL = https://drive.google.com/drive/u/0/folders/1q5CYV7xYfHlsLw81JGj9SH1aYe0WBDL1

document.getElementById('getGpsBtn').addEventListener('click', () => {
  const status = document.getElementById('status');
  status.textContent = 'Locating…';
  if (!navigator.geolocation) {
    status.textContent = 'Geolocation not supported by your browser';
    return;
  }
  navigator.geolocation.getCurrentPosition((pos) => {
    const lat = pos.coords.latitude.toFixed(7);
    const lng = pos.coords.longitude.toFixed(7);
    document.getElementById('gpsLat').value = lat;
    document.getElementById('gpsLng').value = lng;
    status.textContent = 'GPS captured';
  }, (err) => {
    status.textContent = 'GPS error: ' + err.message;
  }, { enableHighAccuracy: true, timeout: 10000 });
});

document.getElementById('d2dForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const status = document.getElementById('status');
  status.textContent = 'Submitting…';

  const payload = {
    fullName: document.getElementById('fullName').value.trim(),
    address: document.getElementById('address').value.trim(),
    mobile: document.getElementById('mobile').value.trim(),
    gpsLat: document.getElementById('gpsLat').value.trim(),
    gpsLng: document.getElementById('gpsLng').value.trim(),
    visitedBy: document.getElementById('visitedBy').value.trim(),
    date: document.getElementById('date').value,
    time: document.getElementById('time').value,
    remarks: document.getElementById('remarks').value.trim(),
    interested: document.getElementById('interested').value
  };

  try {
    if (!WEB_APP_URL || WEB_APP_URL === "YOUR_WEB_APP_URL_HERE") {
      status.textContent = "No Web App URL set — submission will be downloaded as CSV. Click 'Download CSV' to save locally.";
      return;
    }

    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    if (res.ok && result.status === "success") {
      status.textContent = "Submission saved successfully.";
      document.getElementById('d2dForm').reset();
      document.getElementById('gpsLat').value = '';
      document.getElementById('gpsLng').value = '';
    } else {
      status.textContent = "Error saving: " + (result.message || JSON.stringify(result));
    }
  } catch (err) {
    status.textContent = "Network error: " + err.message;
  }
});

// Download CSV fallback
document.getElementById('downloadCsv').addEventListener('click', () => {
  const row = [
    new Date().toISOString(),
    document.getElementById('fullName').value,
    document.getElementById('address').value.replace(/\n/g, " "),
    document.getElementById('mobile').value,
    document.getElementById('gpsLat').value,
    document.getElementById('gpsLng').value,
    document.getElementById('visitedBy').value,
    document.getElementById('date').value,
    document.getElementById('time').value,
    document.getElementById('remarks').value.replace(/\n/g, " "),
    document.getElementById('interested').value
  ];
  const csv = row.map(v => '"' + (String(v || "").replace(/"/g,'""')) + '"').join(",") + "\\n";
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'd2d_submission_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>

